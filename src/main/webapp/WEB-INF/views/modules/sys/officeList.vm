#set($title='机构管理')
#parse("/include/treetable.vm")
<script type="text/javascript">
	$(document).ready(function() {
		var tpl = $("#treeTableTpl").html().replace(/(\/\/\<!\-\-)|(\/\/\-\->)/g,"");
		var data = $jsonMapper.toJsonString(${list}), #if(! ${office.id}) rootId="${office.id}" #else rootId="0" #end;
		addRow("#treeTableList", tpl, data, rootId, true);
		$("#treeTable").treeTable({expandLevel : 5});
	});
	function addRow(list, tpl, data, pid, root){
		for (var i=0; i<data.length; i++){
			var row = data[i];
            if ($stringUtils.jsGetVal('row.parentId') == pid){
				$(list).append(Mustache.render(tpl, {
					dict: {
						type: getDictLabel($jsonMapper.toJsonString($dictUtils.getDictList('sys_office_type')), row.type)
					}, pid: (root?0:pid), row: row
				}));
				addRow(list, tpl, data, row.id);
			}
		}
	}
</script>
<ul class="nav nav-tabs">
	<li class="active"><a href="${ctx}/sys/office/list?id=$!{office.id}&parentIds=$!{office.parentIds}">机构列表</a></li>
	#if($shiro.hasPermission('sys:office:edit'))
        <li><a href="${ctx}/sys/office/form?parent.id=$!{office.id}">机构添加</a></li>
	#end
</ul>
#sysMessage($!{message})
<table id="treeTable" class="table table-striped table-bordered table-condensed">
	<thead><tr><th>机构名称</th><th>归属区域</th><th>机构编码</th><th>机构类型</th><th>备注</th>#if($shiro.hasPermission('sys:office:edit'))<th>操作</th>#end</tr></thead>
	<tbody id="treeTableList"></tbody>
</table>
<script type="text/template" id="treeTableTpl">
	<tr id="{{row.id}}" pId="{{pid}}">
		<td><a href="${ctx}/sys/office/form?id={{row.id}}">{{row.name}}</a></td>
		<td>{{row.area.name}}</td>
		<td>{{row.code}}</td>
		<td>{{dict.type}}</td>
		<td>{{row.remarks}}</td>
		#if($shiro.hasPermission('sys:office:edit'))
			<td>
				<a href="${ctx}/sys/office/form?id={{row.id}}">修改</a>
				<a href="${ctx}/sys/office/delete?id={{row.id}}" onclick="return confirmx('要删除该机构及所有子机构项吗？', this.href)">删除</a>
				<a href="${ctx}/sys/office/form?parent.id={{row.id}}">添加下级机构</a>
			</td>
		#end
	</tr>
</script>